{% extends "layout.html" %}

{% block title %}{{ _("Receta") }}{% endblock %}

{% block main %}
<form id="optimizerForm" class="optimizer" method="post" action="{{ url_for('optimize') }}">
  {{ form.hidden_tag() }}
  {{ form.effect_weights_json(id="effect_weights_json") }}
  <!-- Diplomas + weights -->
  <fieldset class="card">
    <legend class="card-legend">
      <strong>{{ _("Diplomas & Efectos Deseados") }}</strong>
    </legend>
    <div class="card-body">

      <div class="diploma-row">
        <div class="diploma-input">
              {{ form.n_diploma(class="n-diploma") }}
        </div>
      </div>
      <div id="weightsContainer" class="weights-grid"></div>
    </div>
  </fieldset>

  <!-- Premium ingredients -->
  <fieldset class="card">
    <legend class="card-legend">
      <strong>{{ _("Evitar Ingredientes (Premium)") }}</strong>
    </legend>
    <div class="card-body">
      <div class="ingredients-grid">
        {% for name in ingredient_names %}
          <label class="ingredient-check">
            <input type="checkbox" name="premium_ingredients[]" value="{{ loop.index0 }}">

            <img
              class="ingredient-check-icon"
              src="{{ url_for('static', filename='ingredients/ingredient' ~ loop.index ~ '.png') }}"
              alt=""
            >

            <span class="ingredient-name" title="{{ _(name) }}">{{ _(name) }}</span>
          </label>
        {% endfor %}
      </div>
    </div>
  </fieldset>

  <!-- Bounds -->
  <fieldset class="card">
    <legend class="card-legend">
      <strong>{{ _("Limitar Búsqueda") }}</strong>
    </legend>
    <div class="card-body">
      <div id="boundsContainer" class="bounds-row"></div>
    </div>
  </fieldset>

  <div class="submit-row">
    <button type="submit" class="game-main-btn">
      <span>{{ _("Buscar Receta") }}</span>
    </button>
  </div>
</form>

<script>
  // ----- Defaults coming from Flask -----
  const DEFAULT_N_DIPLOMAS    = {{ form.n_diploma.data | tojson }};
  const DEFAULT_WEIGHTS       = JSON.parse({{ form.effect_weights_json.data | tojson }});
  const DEFAULT_MAX_INGR      = {{ form.alpha_UB.data | tojson }};
  const DEFAULT_MAX_PROB      = {{ form.prob_UB.data | tojson }};
  const DEFAULT_SEARCH_DEPTH  = {{ form.n_starts.data | tojson }};
  const EFFECT_NAMES = [
    {% for n in effect_names %}
      {{ _(n) | tojson }}{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  const nDiplomaEl = document.getElementById("{{ form.n_diploma.id }}");
  const weightsContainer = document.getElementById("weightsContainer");
  const boundsContainer = document.getElementById("boundsContainer");
  const weightsHidden = document.getElementById("effect_weights_json");

  function updateHiddenWeights(values){
    if (weightsHidden) weightsHidden.value = JSON.stringify(values);
  }

  function makeRangeCard({
    labelText,
    name,
    iconSrc,
    min,
    max,
    step,
    value,
    format = (x) => x
  }) {
    const card = document.createElement("div");
    card.className = "weight-card";

    const topRow = document.createElement("div");
    topRow.className = "weight-top-row";

    if (iconSrc) {
      const img = document.createElement("img");
      img.src = iconSrc;
      img.className = "effect-icon";
      img.alt = labelText;
      topRow.appendChild(img);
    }

    const valueText = document.createElement("span");
    valueText.className = "weight-value";
    valueText.textContent = format(value);

    topRow.appendChild(valueText);
    card.appendChild(topRow);

    const slider = document.createElement("input");
    slider.type = "range";
    slider.name = name;
    slider.min = String(min);
    slider.max = String(max);
    slider.step = String(step);
    slider.value = String(value);

    card.appendChild(slider);

    const label = document.createElement("div");
    label.className = "weight-label";
    label.textContent = labelText;
    label.title = labelText;

    card.appendChild(label);

    slider.addEventListener("input", () => {
      valueText.textContent = format(slider.value);
    });

    return card;
  }

  function rebuildWeights() {
    const n = Number(nDiplomaEl.value);
    weightsContainer.innerHTML = "";
    if (n < 1 || n > EFFECT_NAMES.length) return;

    const current = [];
    for (let i = 0; i < n; i++) {
      const defaultW = (DEFAULT_WEIGHTS[i] ?? 0);

      const card = makeRangeCard({
        labelText: EFFECT_NAMES[i] ?? `Effect ${i + 1}`,
        iconSrc: `/static/effects/effect${i + 1}.png`,
        // no name; we submit weights via hidden JSON field
        name: "",
        min: 0,
        max: 1,
        step: 0.01,
        value: defaultW,
        format: (x) => Number(x).toFixed(2),
      });

      // Keep current values in sync
      const slider = card.querySelector('input[type="range"]');
      current[i] = defaultW;
      slider.addEventListener("input", () => {
        current[i] = Number(slider.value);
        updateHiddenWeights(current);
      });

      weightsContainer.appendChild(card);
    }

    initRangeFills(weightsContainer);
    updateHiddenWeights(current);
  }

  boundsContainer.append(
    makeRangeCard({
      labelText: "{{ _('máx cantidad por ingrediente') }}",
      name: "{{ form.alpha_UB.name }}",
      min: 1,
      max: 25,
      step: 1,
      value: DEFAULT_MAX_INGR,
      format: (x) => String(parseInt(x, 10)),
    }),
    makeRangeCard({
      labelText: "{{ _('máx probabilidad por efecto') }}",
      name: "{{ form.prob_UB.name }}",
      min: 1,
      max: 100,
      step: 1,
      value: DEFAULT_MAX_PROB,
      format: (x) => String(parseInt(x, 10)),
    }),
    makeRangeCard({
      labelText: "{{ _('profundidad de búsqueda') }}",
      name: "{{ form.n_starts.name }}",
      min: 1,
      max: 100,
      step: 1,
      value: DEFAULT_SEARCH_DEPTH,
      format: (x) => String(parseInt(x, 10)),
    })
  );

  rebuildWeights();
  nDiplomaEl.addEventListener("change", rebuildWeights);

  function setRangeFill(el){
    const min = Number(el.min ?? 0);
    const max = Number(el.max ?? 100);
    const val = Number(el.value ?? 0);
    const p = ((val - min) / (max - min)) * 100;
    el.style.setProperty("--p", p + "%");
  }

  function initRangeFills(root=document){
    root.querySelectorAll('input[type="range"]').forEach(el => {
      setRangeFill(el);
      el.addEventListener("input", () => setRangeFill(el));
    });
  }

  initRangeFills();
</script>
{% endblock %}