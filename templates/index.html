{% extends "layout.html" %}

{% block title %}Receta{% endblock %}

{% block main %}
<form id="optimizerForm" class="optimizer" method="post" action="/optimize">
  <!-- Diplomas + weights -->
  <fieldset class="card">
    <legend><strong>Diplomas &amp; Efectos Deseados</strong></legend>

    <div class="diploma-row">
      <div class="diploma-input">
        <input
          type="number"
          id="n_diploma"
          name="n_diploma"
          min="1"
          max="{{ effect_names| length}}"
          step="1"
          value="{{ n_diplomas }}"
          required
          class="n-diploma"
        />
        <span class="hint">max {{effect_names| length}}</span>
      </div>
    </div>

    <div id="weightsContainer" class="weights-grid"></div>
  </fieldset>

  <!-- Premium ingredients -->
  <fieldset class="card">
    <legend><strong>Evitar Ingredientes (Premium)</strong></legend>

    <div class="ingredients-grid">
      {% for name in ingredient_names %}
        <label>
          <input type="checkbox" name="premium_ingredients[]" value="{{ name }}">
          {{ name }}
        </label>
      {% endfor %}
    </div>
  </fieldset>

  <!-- Bounds -->
  <fieldset class="card">
    <legend><strong>Limitar Búsqueda</strong></legend>
    <div id="boundsContainer" class="bounds-row"></div>
  </fieldset>

  <div class="submit-row">
    <button type="submit" class="btn-submit">Buscar Receta</button>
  </div>
</form>

<script>
  // ----- Defaults coming from Flask -----
  const DEFAULT_N_DIPLOMAS    = {{ n_diplomas | tojson }};
  const DEFAULT_WEIGHTS       = {{ effect_weights | tojson }};  // array length = n_diplomas
  const DEFAULT_MAX_INGR      = {{ max_ingredients | tojson }};
  const DEFAULT_MAX_PROB      = {{ max_effect_prob | tojson }};
  const DEFAULT_SEARCH_DEPTH  = {{ search_depth | tojson }};
  const EFFECT_NAMES          = {{ effect_names | tojson }};
  
  const nDiplomaEl = document.getElementById("n_diploma");
  const weightsContainer = document.getElementById("weightsContainer");
  const boundsContainer = document.getElementById("boundsContainer");

  

  function makeRangeCard({
    labelText,
    name,
    iconSrc,
    min,
    max,
    step,
    value,
    format = (x) => x
  }) {
    const card = document.createElement("div");
    card.className = "weight-card";

    // --- top row: icon + value ---
    const topRow = document.createElement("div");
    topRow.className = "weight-top-row";

    if (iconSrc) {
      const img = document.createElement("img");
      img.src = iconSrc;
      img.className = "effect-icon";
      img.alt = labelText;
      topRow.appendChild(img);
    }

    const valueText = document.createElement("span");
    valueText.className = "weight-value";
    valueText.textContent = format(value);

    topRow.appendChild(valueText);
    card.appendChild(topRow);

    // --- slider ---
    const slider = document.createElement("input");
    slider.type = "range";
    slider.name = name;
    slider.min = String(min);
    slider.max = String(max);
    slider.step = String(step);
    slider.value = String(value);

    card.appendChild(slider);

    // --- label below slider ---
    const label = document.createElement("div");
    label.className = "weight-label";
    label.textContent = labelText;
    label.title = labelText; // tooltip on hover

    card.appendChild(label);

    slider.addEventListener("input", () => {
      valueText.textContent = format(slider.value);
    });

    return card;
  }
  function rebuildWeights() {
    const n = Number(nDiplomaEl.value);
    weightsContainer.innerHTML = "";
    if (n < 1 || n > EFFECT_NAMES.length) return;

    for (let i = 0; i < n; i++) {
      const defaultW = (DEFAULT_WEIGHTS[i] ?? 0);

      weightsContainer.appendChild(
        makeRangeCard({
          labelText: EFFECT_NAMES[i] ?? `Effect ${i + 1}`,
          iconSrc: `/static/effects/effect${i + 1}.png`,
          name: "effect_weights[]",
          min: 0,
          max: 1,
          step: 0.01,
          value: defaultW,
          format: (x) => Number(x).toFixed(2),
        })
      );
    }
  }

  // Build bounds (defaults from Flask)
  boundsContainer.append(
    makeRangeCard({
      labelText: "máx cantidad por ingrediente",
      name: "alpha_UB",
      min: 1,
      max: 25,
      step: 1,
      value: DEFAULT_MAX_INGR,
      format: (x) => String(parseInt(x, 10)),
    }),
    makeRangeCard({
      labelText: "máx probabilidad por efecto",
      name: "prob_UB",
      min: 1,
      max: 100,
      step: 1,
      value: DEFAULT_MAX_PROB,
      format: (x) => String(parseInt(x, 10)),
    }),
    makeRangeCard({
      labelText: "profundidad de búsqueda",
      name: "n_starts",
      min: 1,
      max: 100,
      step: 1,
      value: DEFAULT_SEARCH_DEPTH,
      format: (x) => String(parseInt(x, 10)),
    })
  );

  // Initialize n_diploma + sliders from defaults
  nDiplomaEl.value = DEFAULT_N_DIPLOMAS;
  rebuildWeights();
  nDiplomaEl.addEventListener("change", rebuildWeights);
</script>
{% endblock %}