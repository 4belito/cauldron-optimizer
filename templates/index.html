{% extends "layout.html" %}

{% block title %}Receta{% endblock %}

{% block main %}
<form id="optimizerForm" class="optimizer" method="post" action="/optimize">
  <!-- Diplomas + weights -->
  <fieldset class="card">
    <legend><strong>Diplomas &amp; Efectos Deseados</strong></legend>

    <div class="diploma-row">
      <div class="diploma-input">
        <input
          type="number"
          id="n_diploma"
          name="n_diploma"
          min="1"
          max="21"
          step="1"
          value="{{ n_diplomas }}"
          required
          class="n-diploma"
        />
        <span class="hint">max 21</span>
      </div>
    </div>

    <div id="weightsContainer" class="weights-grid"></div>
  </fieldset>

  <!-- Premium ingredients -->
  <fieldset class="card">
    <legend><strong>Evitar Ingredientes Premium</strong></legend>

    <div class="ingredients-grid">
      <label><input type="checkbox" name="premium_ingredients[]" value="Espora Ignea"> Espora Ignea</label>
      <label><input type="checkbox" name="premium_ingredients[]" value="Escarabanuez"> Escarabanuez</label>
      <label><input type="checkbox" name="premium_ingredients[]" value="Cascaron de Mana"> Cascaron de Mana</label>
      <label><input type="checkbox" name="premium_ingredients[]" value="Iris Volador"> Iris Volador</label>

      <label><input type="checkbox" name="premium_ingredients[]" value="Huevo de Medusa"> Huevo de Medusa</label>
      <label><input type="checkbox" name="premium_ingredients[]" value="Lima de Oruga"> Lima de Oruga</label>
      <label><input type="checkbox" name="premium_ingredients[]" value="Flor de hierba mora"> Flor de hierba mora</label>
      <label><input type="checkbox" name="premium_ingredients[]" value="Lenguas burlonas"> Lenguas burlonas</label>

      <label><input type="checkbox" name="premium_ingredients[]" value="Brote ocular"> Brote ocular</label>
      <label><input type="checkbox" name="premium_ingredients[]" value="hoja de agricabello"> hoja de agricabello</label>
      <label><input type="checkbox" name="premium_ingredients[]" value="capullo de nube de algodon"> capullo de nube de algodon</label>
      <label><input type="checkbox" name="premium_ingredients[]" value="trufa orejera"> trufa orejera</label>
    </div>
  </fieldset>

  <!-- Bounds -->
  <fieldset class="card">
    <legend><strong>Limitar Búsqueda</strong></legend>
    <div id="boundsContainer" class="bounds-row"></div>
  </fieldset>

  <div class="submit-row">
    <button type="submit" class="btn-submit">Buscar Receta</button>
  </div>
</form>

<script>
  // ----- Defaults coming from Flask -----
  const DEFAULT_N_DIPLOMAS    = {{ n_diplomas | tojson }};
  const DEFAULT_WEIGHTS       = {{ effect_weights | tojson }};  // array length = n_diplomas
  const DEFAULT_MAX_INGR      = {{ max_ingredients | tojson }};
  const DEFAULT_MAX_PROB      = {{ max_effect_prob | tojson }};
  const DEFAULT_SEARCH_DEPTH  = {{ search_depth | tojson }};

  const nDiplomaEl = document.getElementById("n_diploma");
  const weightsContainer = document.getElementById("weightsContainer");
  const boundsContainer = document.getElementById("boundsContainer");

  const EFFECT_NAMES = [
    "Monedas","Provisiones","Cuartel Fuerza","Ordinarios Básicos","Ordinarios Refinados",
    "Ordinarios Preciosos","Entrenamiento Fuerza","Asentamiento","Orcos","Mana",
    "Mercenarios Fuerza","Semillas","Sensitivos Básicos","Sensitivos Refinados",
    "Sensitivos Preciosos","Entrenamiento Salud","Mercenarios Salud","Unurium",
    "Ascendidos Básicos","Ascendidos Refinados","Ascendidos Preciosos",
  ];

  function makeRangeCard({ labelText, name, min, max, step, value, format = (x) => x }) {
    const card = document.createElement("div");
    card.className = "weight-card";

    const title = document.createElement("div");
    title.className = "weight-title";

    const label = document.createElement("span");
    label.className = "weight-label";
    label.textContent = labelText;

    const valueText = document.createElement("span");
    valueText.className = "weight-value";
    valueText.textContent = format(value);

    title.append(label, valueText);

    const slider = document.createElement("input");
    slider.type = "range";
    slider.name = name;
    slider.min = String(min);
    slider.max = String(max);
    slider.step = String(step);
    slider.value = String(value);
    slider.style.width = "100%";
    slider.style.marginTop = "6px";

    slider.addEventListener("input", () => {
      valueText.textContent = format(slider.value);
    });

    card.append(title, slider);
    return card;
  }

  function rebuildWeights() {
    const n = Number(nDiplomaEl.value);
    weightsContainer.innerHTML = "";
    if (!Number.isInteger(n) || n < 1 || n > 21) return;

    for (let i = 0; i < n; i++) {
      const defaultW = (DEFAULT_WEIGHTS[i] ?? 0);
      weightsContainer.appendChild(
        makeRangeCard({
          labelText: EFFECT_NAMES[i] ?? `Effect ${i + 1}`,
          name: "effect_weights[]",
          min: 0,
          max: 1,
          step: 0.01,
          value: defaultW,
          format: (x) => Number(x).toFixed(2),
        })
      );
    }
  }

  // Build bounds (defaults from Flask)
  boundsContainer.append(
    makeRangeCard({
      labelText: "máx cantidad por ingrediente",
      name: "alpha_UB",
      min: 1,
      max: 25,
      step: 1,
      value: DEFAULT_MAX_INGR,
      format: (x) => String(parseInt(x, 10)),
    }),
    makeRangeCard({
      labelText: "máx probabilidad por efecto",
      name: "prob_UB",
      min: 1,
      max: 100,
      step: 1,
      value: DEFAULT_MAX_PROB,
      format: (x) => String(parseInt(x, 10)),
    }),
    makeRangeCard({
      labelText: "profundidad de búsqueda",
      name: "n_starts",
      min: 1,
      max: 100,
      step: 1,
      value: DEFAULT_SEARCH_DEPTH,
      format: (x) => String(parseInt(x, 10)),
    })
  );

  // Initialize n_diploma + sliders from defaults
  nDiplomaEl.value = DEFAULT_N_DIPLOMAS;
  rebuildWeights();
  nDiplomaEl.addEventListener("change", rebuildWeights);
</script>
{% endblock %}