{% extends "layout.html" %}

{% block title %}{{ _("Receta") }}{% endblock %}

{% block main %}
<form id="optimizerForm" class="optimizer" method="post" action="{{ url_for('optimize') }}">
  {{ form.hidden_tag() }}
  {{ form.effect_weights_json(id="effect_weights_json") }}
  {{ form.language() }}
  <!-- Diplomas + weights -->
  <fieldset class="card">
    <legend class="card-legend">
      <strong>{{ _("Diplomas & Efectos Deseados") }}</strong>
    </legend>
    <div class="card-body">

      <div class="diploma-row">
        <div class="diploma-input">
              {{ form.n_diploma(class="n-diploma") }}
        </div>
      </div>
      <div id="weightsContainer" class="weights-grid"></div>
    </div>
  </fieldset>

  <!-- Premium ingredients -->
  <fieldset class="card">
    <legend class="card-legend">
      <strong>{{ _("Evitar Ingredientes (Premium)") }}</strong>
    </legend>
    <div class="card-body">
      <div class="ingredients-grid">
        {% set premiums = session.get('premium_ingredients', []) %}
        {% for name in ingredient_names %}
          <label class="ingredient-check">
            <input type="checkbox" name="premium_ingredients[]" value="{{ loop.index0 }}"
            {% if loop.index0 in premiums %}checked{% endif %}
            >

            <img
              class="ingredient-check-icon"
              src="{{ url_for('static', filename='ingredients/ingredient' ~ loop.index ~ '.png') }}"
              alt=""
            >

            <span class="ingredient-name" title="{{ _(name) }}">{{ _(name) }}</span>
          </label>
        {% endfor %}
      </div>
    </div>
  </fieldset>

  <!-- Bounds -->
  <fieldset class="card">
    <legend class="card-legend">
      <strong>{{ _("Limitar BÃºsqueda") }}</strong>
    </legend>
    <div class="card-body">
      <div id="boundsContainer" class="bounds-row"></div>
    </div>
  </fieldset>

  <div class="submit-row">
    <button type="submit" class="game-btn game-btn-main">
      <span>{{ _("Buscar Receta") }}</span>
    </button>
  </div>
</form>

<script>
  // Inject Flask data for optimizer.js
  window.OPTIMIZER_CONFIG = {
    defaultWeights: JSON.parse({{ form.effect_weights_json.data | tojson }}),
    effectNames: [
      {% for n in effect_names %}
        {{ _(n) | tojson }}{{ "," if not loop.last }}
      {% endfor %}
    ],
    dom: {
      nDiploma: document.getElementById("{{ form.n_diploma.id }}"),
      weightsContainer: document.getElementById("weightsContainer"),
      boundsContainer: document.getElementById("boundsContainer"),
      weightsHidden: document.getElementById("effect_weights_json"),
      form: document.getElementById("optimizerForm"),
    },
    boundsFields: [
      {% for field in [form.alpha_UB, form.prob_UB, form.n_starts] %}
        {
          labelText: "{{ field.label.text }}",
          name: "{{ field.name }}",
          min: "{{ field.validators[1].min }}",
          max: "{{ field.validators[1].max }}",
          value: {{ field.data | tojson }},
        }{{ "," if not loop.last }}
      {% endfor %}
    ],
  };

  window.cauldronAutofill = function(data) {
    const dom = window.OPTIMIZER_CONFIG.dom;

    // Fill diplomas if provided
    if (typeof data.n_diploma === "number") {
      dom.nDiploma.value = data.n_diploma;
    }

    // Fill premium ingredients if provided
    if (Array.isArray(data.premium_ingr)) {
      document
        .querySelectorAll("input[name='premium_ingredients[]']")
        .forEach(cb => cb.checked = false);

      data.premium_ingr.forEach(i => {
        const checkbox = document.querySelector(
          `input[name="premium_ingredients[]"][value="${i}"]`
        );
        if (checkbox) checkbox.checked = true;
      });
    }
};
</script>
<script src="{{ url_for('static', filename='js/optimizer.js') }}"></script>
{% endblock %}